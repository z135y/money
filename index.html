<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸµ èŒ¶è‘‰ POS - æ•¸æ“šåˆ†æç‰ˆ</title>
    <style>
        :root { 
            --primary: #2c3e50; --success: #27ae60; --warning: #e67e22; 
            --danger: #e74c3c; --bg: #f2f2f7; --card-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; margin: 0; background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* å·¦å´ï¼šå•†å“é¸æ“‡å€ */
        .product-area { flex: 7; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; align-content: start; }
        .category-title { grid-column: 1 / -1; font-size: 14px; color: #7f8c8d; font-weight: bold; margin-top: 20px; margin-bottom: 8px; border-left: 4px solid var(--primary); padding-left: 10px; text-transform: uppercase; }
        .category-title:first-child { margin-top: 0; }

        .product-card { background: white; border-radius: 12px; padding: 12px; text-align: center; box-shadow: var(--card-shadow); cursor: pointer; transition: all 0.2s; border: 2px solid transparent; user-select: none; position: relative; }
        .product-card:active { transform: translateY(2px); border-color: var(--success); }
        .product-card.out-of-stock { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        .product-card.out-of-stock::after { content: "è£œè²¨ä¸­"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--danger); font-weight: bold; border: 2px solid var(--danger); padding: 4px 8px; border-radius: 4px; background: white; }

        .p-name { font-weight: bold; font-size: 15px; color: var(--primary); margin: 5px 0; }
        .p-price { color: var(--warning); font-weight: bold; font-size: 14px; }
        .p-stock { font-size: 11px; color: #95a5a6; margin-top: 5px; background: #f8f9fa; padding: 2px 6px; border-radius: 4px; }
        .tag { width: 30px; height: 5px; border-radius: 3px; margin: 0 auto 8px auto; }

        /* å³å´ï¼šçµå¸³èˆ‡åˆ†æå€ */
        .sidebar { flex: 3; background: white; display: flex; flex-direction: column; border-left: 1px solid #dcdde1; box-shadow: -5px 0 20px rgba(0,0,0,0.05); min-width: 350px; }
        .cart-header { padding: 18px; background: var(--primary); color: white; font-weight: bold; text-align: center; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        
        .cart-list { flex: 1; overflow-y: auto; padding: 10px; border-bottom: 1px solid #f1f2f6; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f1f2f6; }
        .item-qty { font-weight: bold; color: white; background: var(--primary); padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .btn-del { color: var(--danger); cursor: pointer; font-size: 20px; margin-left: 10px; padding: 5px; }

        /* æ•¸æ“šæ”¶é›†å€ (æ¥­ç•Œæ¨™æº–æ¨™ç±¤è¨­è¨ˆ) */
        .analytics-box { padding: 15px; background: #fff; border-top: 1px solid #f1f2f6; }
        .label-group { font-size: 12px; color: #7f8c8d; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; }
        .label-group span { margin-right: 5px; }
        
        .toggle-group { display: flex; gap: 6px; margin-bottom: 12px; }
        .toggle-btn { flex: 1; padding: 10px 0; font-size: 13px; border: 1px solid #eee; background: #f9f9f9; border-radius: 8px; cursor: pointer; color: #2f3640; transition: 0.2s; }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* çµå¸³èˆ‡æŠ˜æ‰£ */
        .checkout-box { padding: 20px; background: #f8f9fa; border-top: 1px solid #dcdde1; }
        .price-row { display: flex; justify-content: space-between; font-size: 14px; color: #636e72; margin-bottom: 5px; }
        .total-row { display: flex; justify-content: space-between; font-size: 28px; font-weight: 900; color: var(--primary); margin: 10px 0; }
        
        .pay-methods { display: flex; gap: 8px; margin-bottom: 15px; }
        .pay-btn { flex: 1; padding: 12px 0; border: 1px solid #dcdde1; border-radius: 8px; cursor: pointer; text-align: center; font-size: 14px; background: white; font-weight: bold; }
        .pay-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .btn-main { width: 100%; padding: 16px; background: var(--success); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }
        .btn-main:disabled { background: #bdc3c7; cursor: not-allowed; }

        /* é€šçŸ¥å…ƒä»¶ */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 30px; border-radius: 50px; color: white; font-weight: bold; z-index: 9999; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        @media (max-width: 768px) { body { flex-direction: column; } .sidebar { min-width: 100%; height: 50vh; } }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="product-area" id="productGrid"></div>

<div class="sidebar">
    <div class="cart-header">
        <span>ğŸ›’ é»é¤æ˜ç´°</span>
        <button onclick="syncStock()" style="background:none; border:none; cursor:pointer; color:rgba(255,255,255,0.6);">ğŸ”„ åŒæ­¥</button>
    </div>
    
    <div class="cart-list" id="cartItems">
        <div style="text-align:center; color:#b2bec3; margin-top:50px;">å°šæœªé¸è³¼å•†å“</div>
    </div>

    <!-- é¡§å®¢ç•«åƒæ•¸æ“šæ”¶é›† -->
    <div class="analytics-box">
        <div class="label-group"><span>ğŸ‘¤ é¡§å®¢æ€§åˆ¥</span></div>
        <div class="toggle-group" id="genderSelect">
            <button class="toggle-btn" onclick="setProfile('gender', 'ç”·', this)">ç”·</button>
            <button class="toggle-btn" onclick="setProfile('gender', 'å¥³', this)">å¥³</button>
            <button class="toggle-btn active" onclick="setProfile('gender', 'æœªçŸ¥', this)">æœªçŸ¥</button>
        </div>

        <div class="label-group"><span>ğŸ‚ å¹´é½¡å±¤åˆ†æ</span></div>
        <div class="toggle-group" id="ageSelect">
            <button class="toggle-btn" onclick="setProfile('age', '20ä»¥ä¸‹', this)">-20</button>
            <button class="toggle-btn" onclick="setProfile('age', '21-35', this)">21-35</button>
            <button class="toggle-btn" onclick="setProfile('age', '36-50', this)">36-50</button>
            <button class="toggle-btn active" onclick="setProfile('age', '51+', this)">51+</button>
        </div>
    </div>

    <div class="checkout-box">
        <div id="priceSummary">
            <div class="total-row"><span>ç¸½è¨ˆ</span><span>$0</span></div>
        </div>

        <div class="pay-methods">
            <div class="pay-btn active" onclick="setPayment('ç¾é‡‘', this)">ç¾é‡‘</div>
            <div class="pay-btn" onclick="setPayment('LinePay', this)">LinePay</div>
            <div class="pay-btn" onclick="setPayment('ä¿¡ç”¨å¡', this)">åˆ·å¡</div>
        </div>

        <button class="btn-main" id="checkoutBtn" onclick="handleCheckout()">ç¢ºèªçµå¸³</button>
        <button onclick="resetCart()" style="width:100%; margin-top:10px; background:none; border:none; color:#e74c3c; cursor:pointer; font-size:12px; text-decoration:underline;">æ¸…ç©ºé‡ä¾†</button>
    </div>
</div>

<script>
    // è«‹æ›¿æ›ç‚ºæ‚¨çš„ Google Apps Script ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz9s2NUQupy7plDN-sRqQdbULRV5T5LE8xE4SYYUE_MR2vqT2O-bt1R5cwnOvhaYS5MYA/exec";

    // åˆå§‹å•†å“èˆ‡åº«å­˜è³‡æ–™ (æ¥­ç•Œå¸¸ç”¨ï¼šID å°å‘é–‹ç™¼)
    const productData = [
        { id: 1, cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'æ–‡å±±åŒ…ç¨®èŒ¶', price: 300, color: '#27ae60', stock: 10 },
        { id: 2, cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'èœœé¦™ç´…èŒ¶', price: 350, color: '#e74c3c', stock: 15 },
        { id: 3, cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'ç´…çƒé¾', price: 450, color: '#d35400', stock: 8 },
        { id: 13, cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'ç„™é¦™èŒ¶ç©—', price: 100, color: '#8d6e63', stock: 20 },
        { id: 5, cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'èŒ¶å±±æ¼«éŠç¦®ç›’', price: 1100, color: '#8e44ad', stock: 5 },
        { id: 14, cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'éŠ€è³ªåŒ…ç¨®ç¦®ç›’', price: 1200, color: '#7f8c8d', stock: 3 },
        { id: 7, cat: "ğŸ¥¤ ç¾èƒèŒ¶é£²", name: 'ç¾èƒ-åŒ…ç¨®', price: 60, color: '#2ecc71', stock: 999 },
        { id: 8, cat: "ğŸ¥¤ ç¾èƒèŒ¶é£²", name: 'ç¾èƒ-ç´…èŒ¶', price: 60, color: '#ff7675', stock: 999 },
        { id: 11, cat: "ğŸ¥¤ ç¾èƒèŒ¶é£²", name: 'å†·æ³¡èŒ¶(ç“¶)', price: 80, color: '#1abc9c', stock: 24 }
    ];

    let cart = {};
    let profile = { gender: 'æœªçŸ¥', age: '51+' };
    let payment = 'ç¾é‡‘';

    // ä»‹é¢åˆå§‹åŒ–ï¼šç¢ºä¿æ¸²æŸ“é ˜å…ˆæ–¼ç¶²è·¯è«‹æ±‚ (UX å„ªåŒ–)
    window.onload = () => {
        renderUI();
        syncStock();
    };

    function notify(msg, isError = false) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.backgroundColor = isError ? '#e74c3c' : '#27ae60';
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    function renderUI() {
        const grid = document.getElementById('productGrid');
        grid.innerHTML = "";
        
        let lastCat = "";
        productData.forEach(p => {
            if(p.cat !== lastCat) {
                const title = document.createElement('div');
                title.className = "category-title";
                title.innerText = p.cat;
                grid.appendChild(title);
                lastCat = p.cat;
            }
            
            const card = document.createElement('div');
            const isOut = p.stock <= 0;
            card.className = `product-card ${isOut ? 'out-of-stock' : ''}`;
            card.onclick = () => isOut ? null : addToCart(p);
            card.innerHTML = `
                <div class="tag" style="background:${p.color}"></div>
                <div class="p-name">${p.name}</div>
                <div class="p-price">$${p.price}</div>
                <div class="p-stock">${isOut ? 'åº«å­˜ä¸è¶³' : 'å‰©é¤˜: '+p.stock}</div>
            `;
            grid.appendChild(card);
        });
    }

    function addToCart(p) {
        const currentQty = cart[p.id]?.qty || 0;
        if(currentQty + 1 > p.stock) return notify("åº«å­˜ä¸è¶³ï¼", true);
        
        cart[p.id] = { ...p, qty: currentQty + 1 };
        updateCartUI();
    }

    function removeFromCart(id) {
        if(cart[id].qty > 1) cart[id].qty--;
        else delete cart[id];
        updateCartUI();
    }

    function updateCartUI() {
        const list = document.getElementById('cartItems');
        const summary = document.getElementById('priceSummary');
        const items = Object.values(cart);
        
        if(items.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:#b2bec3; margin-top:50px;">å°šæœªé¸è³¼å•†å“</div>`;
            summary.innerHTML = `<div class="total-row"><span>ç¸½è¨ˆ</span><span>$0</span></div>`;
            return;
        }

        list.innerHTML = items.map(i => `
            <div class="cart-item">
                <div style="flex:1">
                    <div style="font-weight:bold; font-size:14px;">${i.name}</div>
                    <div style="font-size:12px; color:#95a5a6">$${i.price}</div>
                </div>
                <div class="item-qty">${i.qty}</div>
                <div class="btn-del" onclick="removeFromCart(${i.id})">Ã—</div>
            </div>
        `).join('');

        const total = items.reduce((sum, i) => sum + (i.price * i.qty), 0);
        summary.innerHTML = `<div class="total-row"><span>ç¸½è¨ˆ</span><span>$${total}</span></div>`;
    }

    function setProfile(key, val, btn) {
        profile[key] = val;
        const parentId = key === 'gender' ? 'genderSelect' : 'ageSelect';
        document.querySelectorAll(`#${parentId} .toggle-btn`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function setPayment(val, btn) {
        payment = val;
        document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function resetCart() {
        cart = {};
        profile = { gender: 'æœªçŸ¥', age: '51+' };
        payment = 'ç¾é‡‘';
        document.querySelectorAll('.toggle-btn, .pay-btn').forEach(b => b.classList.remove('active'));
        // æ¢å¾©é è¨­ Active ç‹€æ…‹
        document.querySelectorAll('.toggle-btn').forEach(b => {
            if(b.innerText === 'æœªçŸ¥' || b.innerText === '51+') b.classList.add('active');
        });
        document.querySelector('.pay-btn').classList.add('active');
        updateCartUI();
    }

    async function syncStock() {
        try {
            const res = await fetch(SCRIPT_URL);
            const stockMap = await res.json();
            productData.forEach(p => {
                if(stockMap[p.id] !== undefined) p.stock = stockMap[p.id];
            });
            renderUI();
        } catch(e) { console.warn("Stock sync fail"); }
    }

    async function handleCheckout() {
        const items = Object.values(cart);
        if(items.length === 0) return notify("è³¼ç‰©è»Šæ˜¯ç©ºçš„", true);

        const btn = document.getElementById('checkoutBtn');
        btn.disabled = true;
        btn.innerText = "å‚³é€äº¤æ˜“ç´€éŒ„...";

        const total = items.reduce((sum, i) => sum + (i.price * i.qty), 0);
        const orderData = {
            itemsString: items.map(i => `${i.name} x ${i.qty}`).join(', '),
            cartItems: items.map(i => ({id: i.id, qty: i.qty})),
            finalTotal: total,
            method: payment,
            gender: profile.gender,
            age: profile.age,
            timestamp: new Date().toLocaleString()
        };

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(orderData)
            });
            notify(`âœ… çµå¸³æˆåŠŸ ($${total})`);
            resetCart();
            await syncStock();
        } catch(e) {
            notify("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯", true);
        } finally {
            btn.disabled = false;
            btn.innerText = "ç¢ºèªçµå¸³";
        }
    }
</script>

</body>
</html>
