<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸµ èŒ¶è‘‰ POS - å…¨åŠŸèƒ½ç‡Ÿé‹ç³»çµ±</title>
    <style>
        :root { 
            --primary: #2c3e50; --success: #27ae60; --warning: #f39c12; 
            --danger: #e74c3c; --line-green: #00c300; --bank-blue: #0984e3; --bg: #f4f7f6;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; margin: 0; background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* ç‹€æ…‹åˆ— */
        .status-header { background: #34495e; color: white; padding: 8px 15px; font-size: 11px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .status-pill { padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .online-pill { background: var(--success); }
        .offline-pill { background: var(--danger); }
        .hw-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; background: #95a5a6; }
        .hw-dot.active { background: var(--success); box-shadow: 0 0 5px var(--success); }

        /* å·¦å´ï¼šå•†å“é¸å–® */
        .product-area { flex: 7; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(135px, 1fr)); gap: 15px; align-content: start; }
        .category-title { grid-column: 1 / -1; font-size: 13px; color: #7f8c8d; font-weight: bold; margin: 15px 0 8px; border-left: 4px solid var(--primary); padding-left: 10px; text-transform: uppercase; }
        .product-card { background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; border: 2px solid transparent; transition: 0.1s; position: relative; display: flex; flex-direction: column; justify-content: space-between; height: 130px; }
        .product-card:active { transform: scale(0.96); border-color: var(--success); }
        .product-card.out-of-stock { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        .product-card.out-of-stock::after { content: "è£œè²¨ä¸­"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--danger); font-weight: bold; border: 1px solid var(--danger); padding: 2px 5px; background: white; border-radius: 4px; font-size: 12px; }
        
        .p-name { font-weight: bold; font-size: 14px; color: var(--primary); display: block; height: 36px; overflow: hidden; line-height: 1.3; }
        .p-price { color: var(--warning); font-weight: bold; font-size: 13px; margin-top: 5px; }
        .p-stock { font-size: 10px; color: #95a5a6; margin-top: 6px; background: #f0f2f5; padding: 2px 6px; border-radius: 4px; display: inline-block; align-self: center; }
        .p-stock.low-stock { color: white; background: var(--danger); }

        /* å³å´ï¼šå´é‚Šæ¬„æµç¨‹ */
        .sidebar { flex: 3; background: white; display: flex; flex-direction: column; border-left: 1px solid #dcdde1; min-width: 360px; box-shadow: -5px 0 15px rgba(0,0,0,0.03); }
        .cart-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .cart-list { flex: 1; overflow-y: auto; padding: 10px; border-bottom: 1px solid #f1f2f6; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        
        /* æµç¨‹æ­¥é©Ÿ */
        .step-section { padding: 12px 15px; border-bottom: 1px solid #f1f2f6; }
        .step-label { font-size: 11px; color: #95a5a6; font-weight: bold; margin-bottom: 8px; display: block; }
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .opt-btn { padding: 8px 0; font-size: 11px; border: 1px solid #eee; background: #f9f9f9; border-radius: 6px; cursor: pointer; transition: 0.2s; text-align: center; }
        .opt-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }

        /* å‚™ä»½æŒ‰éˆ•å€ */
        .drive-backup { padding: 10px 15px; background: #e8f0fe; font-size: 11px; display: flex; justify-content: space-between; align-items: center; color: #1967d2; border-top: 1px solid #d2e3fc; }
        .btn-save-file { border:none; background:#1967d2; color:white; padding:2px 8px; border-radius:4px; cursor:pointer; font-weight: bold; }

        /* ç¸½è¨ˆèˆ‡æ”¯ä»˜ */
        .footer-section { padding: 20px; background: #fafafa; border-top: 1px solid #eee; }
        .price-row { display: flex; justify-content: space-between; font-size: 13px; color: #7f8c8d; margin-bottom: 4px; }
        .total-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .total-val { font-size: 32px; font-weight: 900; color: var(--primary); }
        .btn-pay { width: 100%; padding: 18px; background: var(--success); color: white; border: none; border-radius: 12px; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(46, 204, 113, 0.2); }

        /* å½ˆçª—æ¨£å¼ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .modal-body { background: white; padding: 30px; border-radius: 24px; text-align: center; width: 320px; }
        .qr-placeholder { width: 220px; height: 220px; margin: 15px auto; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 10px; overflow: hidden; border: 1px solid #eee; }
        .qr-placeholder img { width: 100%; height: 100%; object-fit: contain; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 12px 25px; border-radius: 30px; color: white; display: none; z-index: 11000; font-size: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        @media (max-width: 768px) { body { flex-direction: column; } .sidebar { min-width: 100%; height: 60vh; } }
    </style>
</head>
<body>

<div id="toast"></div>

<!-- æ”¯ä»˜æ ¸å°å½ˆçª— -->
<div class="modal" id="payModal">
    <div class="modal-body">
        <h3 id="mTitle" style="margin:0;">æ”¯ä»˜æ ¸å°</h3>
        <p style="font-size: 12px; color: #95a5a6; margin: 5px 0 15px;">è«‹å‘é¡§å®¢å‡ºç¤º QR Code ä¸¦ç¢ºèªé‡‘é¡</p>
        <div id="bankInfo" style="background:#f1f2f6; padding:12px; border-radius:12px; font-size:13px; text-align:left; margin-bottom:15px; display:none; line-height:1.6;">
            <b>å°æ–° (812)</b><br>å¸³è™Ÿï¼š2888-10-2195140-5<br>æˆ¶åï¼šé„­å®‡ç¿”
        </div>
        <div class="qr-placeholder"><img id="mQR" src="" alt="æ”¶æ¬¾åœ–ç‰‡"></div>
        <div id="mPrice" style="font-size: 28px; font-weight: 900; color: var(--danger);">$0</div>
        <button class="btn-pay" onclick="submitFinalOrder()">å·²æ”¶åˆ°æ¬¾é … (çµå¸³)</button>
        <button onclick="closeModal()" style="background:none; border:none; color:#bdc3c7; margin-top:15px; font-size:12px; cursor:pointer;">è¿”å›ä¿®æ”¹</button>
    </div>
</div>

<div style="display:flex; flex-direction:column; width:100%;">
    <!-- é ‚éƒ¨ç‹€æ…‹åˆ— -->
    <div class="status-header">
        <div>
            <span class="status-pill" id="netStatusPill">åµæ¸¬ä¸­...</span>
            <span style="margin: 0 10px;">|</span>
            <span id="syncStatus">é›²ç«¯åŒæ­¥ä¸­...</span>
        </div>
        <div>
            <span class="hw-dot active"></span> <span id="usbStatus">USB æƒææ§å°±ç·’</span>
        </div>
    </div>

    <div style="display:flex; flex:1; overflow:hidden;">
        <div class="product-area" id="productGrid"></div>

        <div class="sidebar">
            <div class="cart-header">
                <span>ğŸ›’ çµå¸³æ¸…å–®</span>
                <button onclick="refreshStock()" style="background:none; border:none; color:white; font-size:12px; cursor:pointer;">åˆ·æ–°åº«å­˜ ğŸ”„</button>
            </div>
            
            <div class="cart-list" id="cartItems">
                <div style="text-align:center; color:#bdc3c7; margin-top:50px;">é»é¸å•†å“æˆ–æƒææ¢ç¢¼</div>
            </div>

            <div class="control-panel">
                <!-- æ­¥é©Ÿ 1: æŠ˜æ‰£ -->
                <div class="step-section">
                    <span class="step-label">1. é¸æ“‡æŠ˜æ‰£</span>
                    <div class="btn-grid" id="discGrid">
                        <button class="opt-btn active" onclick="setOpt('disc', 0, this)">ç„¡</button>
                        <button class="opt-btn" onclick="setOpt('disc', 0.9, this)">9æŠ˜</button>
                        <button class="opt-btn" onclick="setOpt('disc', 0.8, this)">8æŠ˜</button>
                        <button class="opt-btn" onclick="setOpt('disc', -50, this)">-50</button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ 2: é¡§å®¢è¼ªå»“ -->
                <div class="step-section">
                    <span class="step-label">2. é¡§å®¢è¼ªå»“ (æ€§åˆ¥ / å¹´é½¡)</span>
                    <div class="btn-grid" id="genderGrid" style="margin-bottom:5px;">
                        <button class="opt-btn active" onclick="setOpt('gender', 'æœªçŸ¥', this)">æœªçŸ¥</button>
                        <button class="opt-btn" onclick="setOpt('gender', 'ç”·', this)">ç”·</button>
                        <button class="opt-btn" onclick="setOpt('gender', 'å¥³', this)">å¥³</button>
                        <button class="opt-btn" onclick="setOpt('gender', 'å¤šå…ƒ', this)">å¤šå…ƒ</button>
                    </div>
                    <div class="btn-grid" id="ageGrid">
                        <button class="opt-btn" onclick="setOpt('age', '-20', this)">-20</button>
                        <button class="opt-btn" onclick="setOpt('age', '21-35', this)">21-35</button>
                        <button class="opt-btn" onclick="setOpt('age', '36-50', this)">36-50</button>
                        <button class="opt-btn active" onclick="setOpt('age', '51+', this)">51+</button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ 3: æ”¯ä»˜æ–¹å¼ -->
                <div class="step-section" style="border-bottom:none;">
                    <span class="step-label">3. æ”¯ä»˜æ–¹å¼</span>
                    <div class="btn-grid" id="methodGrid">
                        <button class="opt-btn active" onclick="setOpt('method', 'ç¾é‡‘', this)">ç¾é‡‘</button>
                        <button class="opt-btn" onclick="setOpt('method', 'LinePay', this)">Line</button>
                        <button class="opt-btn" onclick="setOpt('method', 'è½‰å¸³', this)">è½‰å¸³</button>
                        <button class="opt-btn" onclick="setOpt('method', 'ä¿¡ç”¨å¡', this)">åˆ·å¡</button>
                    </div>
                </div>
            </div>

            <!-- Drive å‚™ä»½æç¤ºå€ -->
            <div class="drive-backup">
                <span>å‚™æ´: é›¢ç·šå‚™ä»½ä½‡åˆ— (<span id="localCount">0</span>)</span>
                <button onclick="downloadLogForDrive()" class="btn-save-file">å­˜è‡³ Drive è³‡æ–™åŒ£</button>
            </div>

            <div class="footer-section">
                <div class="price-row"><span>å°è¨ˆ (åŸåƒ¹)</span><span id="subTotal">$0</span></div>
                <div class="price-row"><span>æŠ˜æ‰£é‡‘é¡</span><span id="discAmt" style="color:var(--danger)">-$0</span></div>
                <div class="total-row">
                    <span style="color: #95a5a6; font-size: 14px;">æ‡‰æ”¶ç¸½è¨ˆ</span>
                    <span class="total-val" id="finalTotal">$0</span>
                </div>
                <button class="btn-pay" onclick="handlePayAction()">ç¢ºèªçµå¸³ä¸¦ä¸Šå‚³</button>
                <button onclick="clearAll()" style="width:100%; border:none; background:none; color:var(--danger); font-size:11px; margin-top:10px; cursor:pointer; text-decoration:underline;">æ¸…ç©ºé‡ä¾†</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- é…ç½®å€ ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz9s2NUQupy7plDN-sRqQdbULRV5T5LE8xE4SYYUE_MR2vqT2O-bt1R5cwnOvhaYS5MYA/exec";
    
    // âœ… è‡ªå®šç¾©æ”¶æ¬¾åœ–ç‰‡ç¶²å€
    const LINE_PAY_QR = "https://drive.google.com/uc?id=1PqMv9Hsnm7kQ1LdaM1dsnWDXHkEuoLtt"
    const BANK_TRANSFER_QR = "https://drive.google.com/uc?id=1V9oZJwjrq9rY1A6Raloa4P2L2Jzh1VpE";

    // å®Œæ•´å“é …ä¸»æª” (å« Barcode)
    const PRODUCTS = [
        { id: 1, barcode: "1001", cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'æ–‡å±±åŒ…ç¨®èŒ¶', price: 300, stock: 0 },
        { id: 2, barcode: "1002", cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'èœœé¦™ç´…èŒ¶', price: 350, stock: 0 },
        { id: 3, barcode: "1003", cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'ç´…çƒé¾', price: 450, stock: 0 },
        { id: 4, barcode: "1004", cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'å‡é ‚çƒé¾', price: 350, stock: 0 },
        { id: 13, barcode: "1013", cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'ç„™é¦™èŒ¶ç©—', price: 100, stock: 0 },
        { id: 5, barcode: "1005", cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'èŒ¶å±±æ¼«éŠç¦®ç›’', price: 1100, stock: 0 },
        { id: 14, barcode: "1014", cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'éŠ€è³ªåŒ…ç¨®ç¦®ç›’', price: 1200, stock: 0 },
        { id: 6, barcode: "1006", cat: "ğŸ“¦ èŒ¶è‘‰èˆ‡ç¦®ç›’", name: 'ç›’è£èŒ¶åŒ…(10å…¥)', price: 250, stock: 0 },
        { id: 7, barcode: "2007", cat: "ğŸ¥¤ ç¾èƒèŒ¶é£²", name: 'ç¾èƒ-æ–‡å±±åŒ…ç¨®', price: 60, stock: 0 },
        { id: 8, barcode: "2008", cat: "ğŸ¥¤ ç¾èƒèŒ¶é£²", name: 'ç¾èƒ-èœœé¦™ç´…èŒ¶', price: 60, stock: 0 },
        { id: 11, barcode: "2011", cat: "ğŸ¥¤ ç¾èƒèŒ¶é£²", name: 'å†·æ³¡èŒ¶ (ç“¶)', price: 80, stock: 0 },
        { id: 12, barcode: "9001", cat: "ğŸ›ï¸ å…¶ä»–", name: 'æè¢‹/åŒ…æ', price: 10, stock: 0 }
    ];

    let cart = {};
    let state = { disc: 0, gender: 'æœªçŸ¥', age: '51+', method: 'ç¾é‡‘' };
    let syncQueue = [];
    let allHistory = []; 
    let barcodeBuffer = "";

    window.onload = () => {
        loadData();
        renderProducts();
        setupUSBScanner();
        initNetMonitor();
        refreshStock();
    };

    function notify(m, isErr = false) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.background = isErr ? 'var(--danger)' : '#333';
        t.style.display = 'block'; setTimeout(() => t.style.display='none', 2500);
    }

    // --- USB ç¡¬é«”æ ¸å¿ƒ (Keyboard Wedge) ---
    function setupUSBScanner() {
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (barcodeBuffer.length > 0) {
                    const p = PRODUCTS.find(x => x.barcode === barcodeBuffer);
                    if(p) { addToCart(p.id); notify(`ğŸ“¢ æƒææˆåŠŸ: ${p.name}`); }
                    barcodeBuffer = "";
                }
            } else if (e.key.length === 1) { barcodeBuffer += e.key; }
            clearTimeout(window.scanT);
            window.scanT = setTimeout(() => { barcodeBuffer = ""; }, 100);
        });
    }

    // --- Google Drive å¯¦é«”å‚™ä»½æ ¸å¿ƒ ---
    function downloadLogForDrive() {
        if (allHistory.length === 0) return notify("ç„¡äº¤æ˜“ç´€éŒ„å¯å‚™ä»½", true);
        const dataStr = JSON.stringify(allHistory, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `POS_Backup_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`;
        a.click();
        notify("ğŸ’¾ å‚™ä»½æª”å·²ç”¢ç”Ÿï¼Œè«‹å­˜å…¥åŒæ­¥è³‡æ–™åŒ£");
    }

    // --- UI æ¸²æŸ“é‚è¼¯ ---
    function renderProducts() {
        const grid = document.getElementById('productGrid');
        grid.innerHTML = ""; let curCat = "";
        PRODUCTS.forEach(p => {
            if(p.cat !== curCat) {
                grid.innerHTML += `<div class="category-title">${p.cat}</div>`;
                curCat = p.cat;
            }
            const isOut = p.stock <= 0 && p.id < 20; 
            const lowClass = (p.stock > 0 && p.stock <= 5) ? 'low-stock' : '';
            grid.innerHTML += `
                <div class="product-card ${isOut ? 'out-of-stock' : ''}" onclick="addToCart(${p.id})">
                    <span class="p-name">${p.name}</span>
                    <div>
                        <span class="p-price">$${p.price}</span><br>
                        <span class="p-stock ${lowClass}">åº«å­˜: ${p.stock}</span>
                    </div>
                </div>`;
        });
    }

    function addToCart(id) {
        const p = PRODUCTS.find(x => x.id === id);
        const curQty = cart[id]?.qty || 0;
        if (p.id < 20 && curQty + 1 > p.stock) return notify(`âŒ åº«å­˜ä¸è¶³`, true);
        cart[id] = { ...p, qty: curQty + 1 };
        updateUI();
    }

    function updateUI() {
        const list = document.getElementById('cartItems');
        const items = Object.values(cart);
        if(items.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:#bdc3c7; margin-top:50px;">é»é¸å•†å“æˆ–æƒææ¢ç¢¼</div>`;
            document.getElementById('subTotal').innerText = "$0";
            document.getElementById('discAmt').innerText = "-$0";
            document.getElementById('finalTotal').innerText = "$0";
            return;
        }
        list.innerHTML = items.map(i => `<div class="cart-item"><span>${i.name}</span><b>x ${i.qty}</b></div>`).join('');
        
        const sub = items.reduce((s, i) => s + (i.price * i.qty), 0);
        let final = sub;
        let discAmt = 0;
        if(state.disc > 0 && state.disc < 1) {
            final = Math.round(sub * state.disc);
            discAmt = sub - final;
        } else if(state.disc < 0) {
            discAmt = Math.abs(state.disc);
            final = Math.max(0, sub - discAmt);
        }
        
        document.getElementById('subTotal').innerText = "$" + sub;
        document.getElementById('discAmt').innerText = "-$" + discAmt;
        document.getElementById('finalTotal').innerText = "$" + final;
    }

    function setOpt(k, v, btn) {
        state[k] = v;
        const g = k === 'disc' ? 'discGrid' : k === 'gender' ? 'genderGrid' : k === 'age' ? 'ageGrid' : 'methodGrid';
        document.querySelectorAll(`#${g} .opt-btn`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateUI();
    }

    // --- æ”¯ä»˜è™•ç† ---
    function handlePayAction() {
        const final = document.getElementById('finalTotal').innerText;
        if(final === "$0") return notify("æ¸…å–®ç‚ºç©º", true);

        if(state.method === 'LinePay' || state.method === 'è½‰å¸³') {
            document.getElementById('mTitle').innerText = state.method === 'LinePay' ? 'LINE Pay' : 'éŠ€è¡Œè½‰å¸³';
            document.getElementById('mQR').src = state.method === 'LinePay' ? LINE_PAY_QR : BANK_TRANSFER_QR;
            document.getElementById('bankInfo').style.display = state.method === 'è½‰å¸³' ? 'block' : 'none';
            document.getElementById('mPrice').innerText = final;
            document.getElementById('payModal').style.display = 'flex';
        } else {
            submitFinalOrder();
        }
    }

    function submitFinalOrder() {
        closeModal();
        const items = Object.values(cart);
        const subtotal = parseInt(document.getElementById('subTotal').innerText.replace("$",""));
        const discAmt = parseInt(document.getElementById('discAmt').innerText.replace("-$",""));
        const total = parseInt(document.getElementById('finalTotal').innerText.replace("$",""));
        
        const payload = {
            itemsString: items.map(i => `${i.name}x${i.qty}`).join(','),
            cartItems: items.map(i => ({id: i.id, qty: i.qty})),
            originalTotal: subtotal,
            discount: discAmt,
            finalTotal: total,
            method: state.method,
            gender: state.gender,
            age: state.age,
            note: state.disc !== 0 ? `æŠ˜æ‰£:${state.disc}` : '',
            ts: Date.now()
        };

        syncQueue.push(payload);
        allHistory.push(payload);
        saveData();
        notify("âœ… å·²å­˜å…¥ç³»çµ±ï¼ŒåŒæ­¥ä¸­...");
        
        // æ¨‚è§€åº«å­˜æ›´æ–°
        items.forEach(item => {
            const p = PRODUCTS.find(x => x.id === item.id);
            if (p) p.stock -= item.qty;
        });

        clearAll();
        renderProducts();
        processQueue();
    }

    // --- æ•¸æ“šæŒä¹…åŒ– ---
    function loadData() {
        const q = localStorage.getItem('tea_pos_v7_queue');
        const h = localStorage.getItem('tea_pos_v7_history');
        if(q) syncQueue = JSON.parse(q);
        if(h) allHistory = JSON.parse(h);
        updateQueueUI();
    }

    function saveData() {
        localStorage.setItem('tea_pos_v7_queue', JSON.stringify(syncQueue));
        localStorage.setItem('tea_pos_v7_history', JSON.stringify(allHistory));
        updateQueueUI();
    }

    function updateQueueUI() {
        const el = document.getElementById('syncStatus');
        const count = document.getElementById('localCount');
        el.innerText = syncQueue.length > 0 ? `å¾…åŒæ­¥: ${syncQueue.length} ç­†` : "é›²ç«¯å·²åŒæ­¥";
        el.parentElement.style.color = syncQueue.length > 0 ? "var(--warning)" : "white";
        count.innerText = allHistory.length;
    }

    async function processQueue() {
        if(!navigator.onLine || syncQueue.length === 0) return;
        const data = syncQueue[0];
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            syncQueue.shift();
            saveData();
            processQueue();
        } catch(e) {}
    }

    function refreshStock() {
        fetch(SCRIPT_URL).then(r => r.json()).then(d => {
            PRODUCTS.forEach(p => { if(d[p.id] !== undefined) p.stock = d[p.id]; });
            renderProducts();
        });
    }

    function initNetMonitor() {
        const up = () => {
            const on = navigator.onLine;
            const pill = document.getElementById('netStatusPill');
            pill.innerText = on ? "ğŸŸ¢ ç·šä¸Šæ¨¡å¼" : "ğŸ”´ é›¢ç·šæ¨¡å¼";
            pill.className = `status-pill ${on ? 'online-pill' : 'offline-pill'}`;
            if(on) processQueue();
        };
        window.addEventListener('online', up); window.addEventListener('offline', up);
        up();
    }

    function clearAll() { cart = {}; updateUI(); }
    function closeModal() { document.getElementById('payModal').style.display = 'none'; }
</script>

</body>
</html>

