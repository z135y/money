<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸµ èŒ¶è‘‰ POS - USB ç¡¬é«”æ•´åˆç‰ˆ</title>
    <style>
        :root { 
            --primary: #2c3e50; --success: #27ae60; --warning: #f39c12; 
            --danger: #e74c3c; --line-green: #00c300; --bg: #f4f7f6;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .product-area { flex: 7; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .sidebar { flex: 3; background: white; display: flex; flex-direction: column; border-left: 1px solid #dcdde1; min-width: 360px; }

        /* Hardware Status Header */
        .hardware-bar { background: #34495e; color: white; padding: 10px 15px; font-size: 12px; display: flex; gap: 15px; }
        .hw-item { display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #95a5a6; }
        .status-dot.active { background: var(--success); box-shadow: 0 0 5px var(--success); }

        /* Product Cards */
        .category-header { grid-column: 1 / -1; font-size: 13px; color: #7f8c8d; font-weight: bold; margin-top: 10px; }
        .product-card { background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border: 2px solid transparent; }
        .product-card:active { background: #f9f9f9; }
        .p-name { font-weight: bold; display: block; }
        .p-code { font-size: 10px; color: #bdc3c7; }

        /* Sidebar Flow */
        .cart-list { flex: 1; overflow-y: auto; padding: 10px; border-bottom: 1px solid #eee; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f5f6fa; font-size: 14px; }
        
        .control-panel { padding: 15px; border-top: 1px solid #eee; }
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .opt-btn { padding: 8px 0; font-size: 11px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; background: #f9f9f9; }
        .opt-btn.active { background: var(--primary); color: white; }

        .total-box { padding: 20px; background: #fafafa; border-top: 1px solid #eee; }
        .total-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-pay { width: 100%; padding: 15px; background: var(--success); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* USB Backup Section */
        .usb-backup { padding: 10px 15px; background: #ebf2f9; font-size: 11px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #d6e4f0; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-body { background: white; padding: 25px; border-radius: 20px; text-align: center; width: 300px; }
        
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 20px; color: white; display: none; z-index: 2000; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="modal" id="payModal">
    <div class="modal-body">
        <h3 id="mTitle">æ”¯ä»˜ç¢ºèª</h3>
        <div id="qrPlaceholder" style="width:180px; height:180px; background:#f0f0f0; margin:15px auto;">
            <img id="mQR" src="" style="width:100%;">
        </div>
        <div id="mPrice" style="font-size: 24px; font-weight: 900; color: var(--danger);">$0</div>
        <button class="btn-pay" onclick="finishOrder()">ç¢ºèªæ”¶åˆ°æ¬¾é …</button>
        <button onclick="closeModal()" style="background:none; border:none; color:#999; margin-top:10px; text-decoration:underline; cursor:pointer;">å–æ¶ˆ</button>
    </div>
</div>

<div style="display:flex; flex-direction:column; width:100%;">
    <!-- USB ç¡¬é«”ç‹€æ…‹åˆ— -->
    <div class="hardware-bar">
        <div class="hw-item">
            <div class="status-dot active" id="scannerStatus"></div>
            <span>USB æƒææ§ (å·²å°±ç·’)</span>
        </div>
        <div class="hw-item" onclick="connectPrinter()" style="cursor:pointer;">
            <div class="status-dot" id="printerStatus"></div>
            <span>USB å°è¡¨æ©Ÿ (é»æ“Šé€£æ¥)</span>
        </div>
        <div id="netStatus" style="margin-left:auto;">é€£ç·šç‹€æ…‹: ğŸŸ¢ ç·šä¸Š</div>
    </div>

    <div style="display:flex; flex:1; overflow:hidden;">
        <div class="product-area" id="productGrid"></div>

        <div class="sidebar">
            <div class="cart-list" id="cartItems">
                <div style="text-align:center; color:#ccc; margin-top:50px;">è«‹é»é¸å•†å“æˆ–æƒææ¢ç¢¼</div>
            </div>

            <div class="control-panel">
                <span class="step-label">é¡§å®¢è¼ªå»“</span>
                <div class="btn-grid" id="profGrid">
                    <button class="opt-btn active" onclick="setOpt('prof', 'æœªçŸ¥', this)">æœªçŸ¥</button>
                    <button class="opt-btn" onclick="setOpt('prof', 'ç”·', this)">ç”·</button>
                    <button class="opt-btn" onclick="setOpt('prof', 'å¥³', this)">å¥³</button>
                    <button class="opt-btn" onclick="setOpt('prof', '50+', this)">50+</button>
                </div>

                <span class="step-label">æ”¯ä»˜æ–¹å¼</span>
                <div class="btn-grid" id="methodGrid">
                    <button class="opt-btn active" onclick="setOpt('meth', 'ç¾é‡‘', this)">ç¾é‡‘</button>
                    <button class="opt-btn" onclick="setOpt('meth', 'LinePay', this)">Line</button>
                    <button class="opt-btn" onclick="setOpt('meth', 'è½‰å¸³', this)">è½‰å¸³</button>
                    <button class="opt-btn" onclick="setOpt('meth', 'åˆ·å¡', this)">åˆ·å¡</button>
                </div>
            </div>

            <div class="usb-backup">
                <span>å‚™ä»½: é›¢ç·šä½‡åˆ— (<span id="queueSize">0</span>)</span>
                <button onclick="exportToUSB()" style="font-size:10px; border:1px solid #3498db; background:white; color:#3498db; border-radius:4px; cursor:pointer;">åŒ¯å‡ºè‡³ USB</button>
            </div>

            <div class="total-box">
                <div class="total-row">
                    <span style="color:#7f8c8d;">æ‡‰æ”¶ç¸½è¨ˆ</span>
                    <span style="font-size:32px; font-weight:900;" id="finalTotal">$0</span>
                </div>
                <button class="btn-pay" onclick="handlePay()">çµå¸³ä¸¦æ‰“å°</button>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz9s2NUQupy7plDN-sRqQdbULRV5T5LE8xE4SYYUE_MR2vqT2O-bt1R5cwnOvhaYS5MYA/exec";

    // ç”¢å“æ•¸æ“šï¼Œå¢åŠ  barcode æ¬„ä½ç”¨æ–¼ USB æƒææ§è­˜åˆ¥
    const PRODUCTS = [
        { id: 1, barcode: "1001", cat: "ğŸ“¦ èŒ¶è‘‰", name: 'æ–‡å±±åŒ…ç¨®èŒ¶', price: 300, stock: 100 },
        { id: 2, barcode: "1002", cat: "ğŸ“¦ èŒ¶è‘‰", name: 'èœœé¦™ç´…èŒ¶', price: 350, stock: 100 },
        { id: 3, barcode: "1003", cat: "ğŸ“¦ èŒ¶è‘‰", name: 'ç´…çƒé¾', price: 450, stock: 100 },
        { id: 7, barcode: "2001", cat: "ğŸ¥¤ é£²å“", name: 'ç¾èƒ-åŒ…ç¨®', price: 60, stock: 999 },
        { id: 11, barcode: "2002", cat: "ğŸ¥¤ é£²å“", name: 'å†·æ³¡èŒ¶ (ç“¶)', price: 80, stock: 100 }
    ];

    let cart = {};
    let config = { prof: 'æœªçŸ¥', meth: 'ç¾é‡‘' };
    let syncQueue = [];
    let barcodeBuffer = ""; // ç”¨æ–¼ç·©å­˜æƒææ§è¼¸å…¥

    window.onload = () => {
        loadQueue();
        renderProducts();
        setupBarcodeScanner();
        initNetworkMonitor();
    };

    // --- USB ç¡¬é«”æ ¸å¿ƒ 1: æ¢ç¢¼æƒææ§ (Keyboard Wedge Mode) ---
    // æ ¹æ“šæ¥­ç•Œæ¨™æº–ï¼Œæƒææ§æ¨¡æ“¬éµç›¤è¼¸å…¥ï¼Œçµå°¾é€šå¸¸å¸¶æœ‰ 'Enter'
    function setupBarcodeScanner() {
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (barcodeBuffer.length > 0) {
                    processBarcode(barcodeBuffer);
                    barcodeBuffer = "";
                }
            } else {
                // æ’é™¤åŠŸèƒ½éµï¼Œåƒ…æ¥æ”¶æ•¸å­—æˆ–è‹±æ–‡å­—å…ƒ
                if (e.key.length === 1) {
                    barcodeBuffer += e.key;
                }
            }
            // é˜²éŒ¯ï¼šå¦‚æœ buffer éé•·ä¸”å¤ªä¹…æ²’ Enterï¼Œå‰‡æ¸…ç©º (Timeout æ©Ÿåˆ¶)
            clearTimeout(window.barcodeTimeout);
            window.barcodeTimeout = setTimeout(() => { barcodeBuffer = ""; }, 100);
        });
    }

    function processBarcode(code) {
        const product = PRODUCTS.find(p => p.barcode === code);
        if (product) {
            add(product.id);
            toast(`ğŸ“¢ æƒææˆåŠŸ: ${product.name}`);
        } else {
            console.warn("Unknown barcode:", code);
        }
    }

    // --- USB ç¡¬é«”æ ¸å¿ƒ 2: USB å°è¡¨æ©Ÿ (Web Serial API) ---
    // é€™éœ€è¦ç€è¦½å™¨æ”¯æ´ Web Serial (Chrome/Edge)
    let printerPort = null;
    async function connectPrinter() {
        if (!("serial" in navigator)) {
            toast("ç€è¦½å™¨ä¸æ”¯æ´ USB ä¸²å£é€šè¨Š", true);
            return;
        }
        try {
            printerPort = await navigator.serial.requestPort();
            await printerPort.open({ baudRate: 9600 });
            document.getElementById('printerStatus').classList.add('active');
            toast("âœ… å°è¡¨æ©Ÿå·²é€£æ¥");
        } catch (e) {
            console.error(e);
            toast("é€£æ¥å¤±æ•—", true);
        }
    }

    // --- USB ç¡¬é«”æ ¸å¿ƒ 3: é›¢ç·šè³‡æ–™åŒ¯å‡ºè‡³ USB (File System Access) ---
    async function exportToUSB() {
        if (syncQueue.length === 0) return toast("æ²’æœ‰å¾…åŒæ­¥è³‡æ–™");
        try {
            const handle = await window.showSaveFilePicker({
                suggestedName: `POS_Backup_${new Date().getTime()}.json`,
                types: [{ description: 'JSON File', accept: {'application/json': ['.json']} }]
            });
            const writable = await handle.createWritable();
            await writable.write(JSON.stringify(syncQueue, null, 2));
            await writable.close();
            toast("ğŸ’¾ å·²å®‰å…¨å‚™ä»½è‡³ USB");
        } catch (e) {
            toast("åŒ¯å‡ºå–æ¶ˆ");
        }
    }

    // --- POS åŸºç¤é‚è¼¯ ---
    function renderProducts() {
        const grid = document.getElementById('productGrid');
        grid.innerHTML = ""; let lastCat = "";
        PRODUCTS.forEach(p => {
            if(p.cat !== lastCat) {
                grid.innerHTML += `<div class="category-header">${p.cat}</div>`;
                lastCat = p.cat;
            }
            grid.innerHTML += `<div class="product-card" onclick="add(${p.id})">
                <span class="p-name">${p.name}</span>
                <span class="p-price">$${p.price}</span>
                <span class="p-code">${p.barcode}</span>
            </div>`;
        });
    }

    function add(id) {
        const p = PRODUCTS.find(x => x.id === id);
        cart[id] = { ...p, qty: (cart[id]?.qty || 0) + 1 };
        updateUI();
    }

    function updateUI() {
        const list = document.getElementById('cartItems');
        const items = Object.values(cart);
        if(items.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:#ccc; margin-top:50px;">è«‹é»é¸å•†å“æˆ–æƒææ¢ç¢¼</div>`;
            document.getElementById('finalTotal').innerText = "$0";
            return;
        }
        list.innerHTML = items.map(i => `<div class="cart-item"><span>${i.name}</span><b>x ${i.qty}</b></div>`).join('');
        const total = items.reduce((s, i) => s + (i.price * i.qty), 0);
        document.getElementById('finalTotal').innerText = "$" + total;
    }

    function setOpt(key, val, btn) {
        config[key] = val;
        const group = key === 'prof' ? 'profGrid' : 'methodGrid';
        document.querySelectorAll(`#${group} .opt-btn`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function handlePay() {
        const total = document.getElementById('finalTotal').innerText;
        if(total === "$0") return;
        
        if(config.meth === 'LinePay' || config.meth === 'è½‰å¸³') {
            document.getElementById('mQR').src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=PAY_${config.meth}`;
            document.getElementById('mPrice').innerText = total;
            document.getElementById('payModal').style.display = 'flex';
        } else {
            finishOrder();
        }
    }

    function finishOrder() {
        const items = Object.values(cart);
        const order = {
            itemsString: items.map(i => `${i.name}x${i.qty}`).join(','),
            total: parseInt(document.getElementById('finalTotal').innerText.replace("$","")),
            method: config.meth,
            profile: config.prof,
            ts: Date.now()
        };

        syncQueue.push(order);
        saveQueue();
        toast("âœ… äº¤æ˜“å·²è¨˜éŒ„");
        resetCart();
        closeModal();
        tryUpload();
    }

    function loadQueue() {
        const saved = localStorage.getItem('pos_usb_queue');
        if(saved) syncQueue = JSON.parse(saved);
        document.getElementById('queueSize').innerText = syncQueue.length;
    }

    function saveQueue() {
        localStorage.setItem('pos_usb_queue', JSON.stringify(syncQueue));
        document.getElementById('queueSize').innerText = syncQueue.length;
    }

    async function tryUpload() {
        if (!navigator.onLine || syncQueue.length === 0) return;
        const data = syncQueue[0];
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            syncQueue.shift();
            saveQueue();
            tryUpload();
        } catch(e) {}
    }

    function initNetworkMonitor() {
        const update = () => {
            const online = navigator.onLine;
            document.getElementById('netStatus').innerText = online ? "é€£ç·šç‹€æ…‹: ğŸŸ¢ ç·šä¸Š" : "é€£ç·šç‹€æ…‹: ğŸ”´ é›¢ç·š";
            if(online) tryUpload();
        };
        window.addEventListener('online', update);
        window.addEventListener('offline', update);
        update();
    }

    function resetCart() { cart = {}; updateUI(); }
    function closeModal() { document.getElementById('payModal').style.display = 'none'; }
    function toast(m, err=false) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.background = err ? 'var(--danger)' : '#333';
        t.style.display = 'block'; setTimeout(() => t.style.display='none', 2500);
    }
</script>

</body>
</html>
